<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SFU Courses Test</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      padding: 2rem;
      background: #f8f9fa;
    }
    h1 { color: #333; }
    select {
      display: block;
      margin: 1rem 0;
      padding: 0.5rem;
      font-size: 1rem;
    }
    #result {
      margin-top: 2rem;
      padding: 1rem;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>SFU Course Selector</h1>

  <label for="year">Year:</label>
  <select id="year"></select>

  <label for="term">Term:</label>
  <select id="term"></select>

  <label for="dept">Department:</label>
  <select id="dept"></select>

  <label for="course">Course:</label>
  <select id="course"></select>

  <label for="section">Section:</label>
  <select id="section"></select>

  <div id="result">Your selected course will appear here.</div>

  <script>
    const backend = "http://localhost:3000";

    const yearSelect = document.getElementById("year");
    const termSelect = document.getElementById("term");
    const deptSelect = document.getElementById("dept");
    const courseSelect = document.getElementById("course");
    const sectionSelect = document.getElementById("section");
    const resultDiv = document.getElementById("result");

    async function fetchAndFill(endpoint, params, select, labelKey = "text") {
      const url = new URL(`${backend}/${endpoint}`);
      if (params) Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));

      const res = await fetch(url);
      const data = await res.json();
      select.innerHTML = "<option value=''>Select...</option>";

      data.forEach(item => {
        const value = item.value || item.text || item;
        const label = item.text || item.value || item;
        const opt = document.createElement("option");
        opt.value = value;
        opt.textContent = label;
        select.appendChild(opt);
      });
    }

    // --- Step 1: Populate years ---
    fetchAndFill("years", null, yearSelect);

    // --- Step 2: When year changes, load terms ---
    yearSelect.addEventListener("change", async () => {
      const year = yearSelect.value;
      if (!year) return;
      await fetchAndFill("terms", { year }, termSelect);
      deptSelect.innerHTML = "";
      courseSelect.innerHTML = "";
      sectionSelect.innerHTML = "";
      resultDiv.textContent = "Select a term...";
    });

    // --- Step 3: When term changes, load departments ---
    termSelect.addEventListener("change", async () => {
      const year = yearSelect.value;
      const term = termSelect.value;
      if (!term) return;
      await fetchAndFill("departments", { year, term }, deptSelect);
      courseSelect.innerHTML = "";
      sectionSelect.innerHTML = "";
      resultDiv.textContent = "Select a department...";
    });

    // --- Step 4: When dept changes, load courses ---
    deptSelect.addEventListener("change", async () => {
      const year = yearSelect.value;
      const term = termSelect.value;
      const dept = deptSelect.value;
      if (!dept) return;
      await fetchAndFill("courses", { year, term, dept }, courseSelect);
      sectionSelect.innerHTML = "";
      resultDiv.textContent = "Select a course...";
    });

    // --- Step 5: When course changes, load sections ---
    courseSelect.addEventListener("change", async () => {
      const year = yearSelect.value;
      const term = termSelect.value;
      const dept = deptSelect.value;
      const course = courseSelect.value;
      if (!course) return;
      await fetchAndFill("sections", { year, term, dept, course }, sectionSelect);
      resultDiv.textContent = "Select a section...";
    });

    // --- Step 6: When section selected, display result ---
    sectionSelect.addEventListener("change", () => {
      const { value: year } = yearSelect;
      const { value: term } = termSelect;
      const { value: dept } = deptSelect;
      const { value: course } = courseSelect;
      const { value: section } = sectionSelect;

      if (section) {
        resultDiv.textContent = `âœ… You selected: ${year} ${term} ${dept} ${course} ${section}`;
      }
    });
  </script>
</body>
</html>
